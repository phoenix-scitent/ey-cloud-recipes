#!/usr/bin/env ruby

require 'fog'

connection = Fog::Storage.new({
  :provider                 => 'AWS',
  :aws_access_key_id        => '<%= @aws_access_key_id %>',
  :aws_secret_access_key    => '<%= @aws_secret_access_key %>'
})

<%- if @upload -%>
directory = connection.directories.get("<%= @backup_bucket %>")
if directory.nil?   
  directory = connection.directories.create(
    :key    => "<%= @backup_bucket %>",
    :public => false,
    :location => "<%= @region %>"
  )
  file = directory.files.create(
    :key    => 'latest.<%= @app_name %>.dump.<%= @backup_ext %>',
    :body   => File.open("/mnt/tmp/latest.<%= @app_name %>.dump.<%= @backup_ext %>"),
    :public => false
  )  
else
  file = directory.files.get("latest.<%= @app_name %>.dump.<%= @backup_ext %>")
  file.body = File.open("/mnt/tmp/latest.<%= @app_name %>.dump.<%= @backup_ext %>")
end
file.save
<%- else -%>
directory = connection.directories.get("<%= @backup_bucket %>")

directory.files.each do |s3_file|
  File.open("/mnt/tmp/#{s3_file.key}", "w") do |local_file|
    local_file.write(s3_file.body)
  end
end	
<%- end -%>
